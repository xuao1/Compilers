# 为SysYF语言生成LLVM IR中间代码

## 1. 实验介绍

### 实验基本要求

+ 学生需要将代码clone到/mnt/cgshare/project/SysYF/中，并将文件夹重命名为IR-Simple-Lab，才能进行评测
+ `report.md` 在文件夹 `report` 下
+ 需要完成 `./Student/task1/ll`目录下的5个文件
+ 需要完成 `./Student/task2/cpp`目录下的6个`.cpp`文件和`./Student/task2/sy`目录下的3个文件`qsort.in`、`qsort.sy`、`qsort.out`
+ 需要完成`./Student/task3/main.cpp`以及`./Student/task3/include/qs_generator.hpp`两个文件，并保持与`./Student/task3/tests`中的测试样例相同的输入输出格式
+ 需要在 `./report/report.md` 中撰写实验报告
  - 实验报告内容包括:
    - 实验要求、问题回答、实验设计、实验难点及解决方案、实验总结、实验反馈(

## 2. LLVM IR 的学习和使用

### LLVM IR 学习

+ LLVM 用 c++ 编写
+ LLVM IR 是一种类型化的三地址中间表示，每条指令只做单一的运算，运算的源操作数和目的操作数都标有类型信息。
+ 本项目涉及的 IR 指令：在 `doc/SysYFIR.md`
+ IR 特征：
  + %2 = add i32 %0, %1
  + 静态单赋值 (SSA) 形式 + 无限寄存器
  + 每个 Value 都具备自身的类型

### `go_upstairs.c`

+ 子函数是上台阶的方案数目，斐波那契序列

+ load 和 store 都是对地址值操作，即第二个操作数类型带 *

+ 取数组元素大概是下列操作：

  ```assembly
  %38 = sext i32 %37 to i64         
  %39 = getelementptr inbounds [10 x i32], [10 x i32]* %4, i64 0, i64 %38
  %40 = load i32, i32* %39, align 4
  ```

  其中，%37 是数组下标，`sext` 是 sign extension

  例子中数组是 int dp[10]，%4 是数组的地址

  %39 就是要取的数组元素的地址值

+ 全部变量用 @ 定义和访问
+ 函数内前几个寄存器：返回值的地址值，参数的地址值，局部变量的地址值，用 `alloca` 分配空间

## 3. SysYF IR 应用编程接口的学习和使用

### 任务描述

要求根据 AST，使用 SysYF IR 应用编程接口来为特定 SysYF 程序手工构建 LLVM IR

编写 cpp 文件，生成与第一关的五个 sy 程序相同逻辑功能的 ll 文件

### `go_uptairs_gen.cpp`

+ 每次进入一个 BasicBlock 先 `set_insert_point()`

+ 最一开始要生成一个 builder:

  ```c++
  auto builder = new IRStmtBuilder(nullptr, module);
  ```

  之后所有 IR 的生成是 `builder->ceater_*()`

### `QSort()`

```c++
int getarray(int a[]){
  int n;
  scanf("%d",&n);
  for(int i=0;i<n;i++)scanf("%d",&a[i]);
  return n;
}
```

```c++
void putarray(int n, int a[]){
  printf("%d:",n);
  for(int i=0;i<n;i++)printf(" %d",a[i]);
  printf("\n");
}
```

## 4. LLVM IR 实现 QuickSort 与 Clang Driver

### 任务描述

了解 `Clang driver` 的结构，弄清楚 `driver `加载c文件、得到中间表示 `AST` 和 `LLVM IR` 、并将其打印的流程。根据 `LLVM IR API` 提供的中间表示构建方式，构建快速排序（QuickSort）算法的 `LLVM IR` 代码，并在`driver`中加载`LLVM IR`程序，通过`JIT`执行。

### Clang driver

`clang` 是 LLVM 的 C/C++ 前端，它能为输入的 C/C++ 源程序产生 LLVM IR 中间表示。

clang driver 是连接 LLVM 整个编译过程和其他工具的一个驱动程序，它可以生成可执行文件或目标代码。

### `qs_generator.hpp`



## 5. 遇到的困难

+ 很多地方的都是用的地址值，直观上感觉是操作数，实际是地址值，如果需要使用对应的操作数，需要先取出操作数。

+ ```c++
  while(i <= right){
          if (arr[i] < arr[pivot]) {
              swap(i, index);
              index++;
          }
          i++;
      }
  ```

  忘记了 index++

+ 第三关，把所有的比较都改成了浮点数比较